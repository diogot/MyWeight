# Xcode
# Build, test, and archive an Xcode workspace on macOS.
# Add steps that install certificates, test, sign, and distribute an app, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/xcode


trigger:
- master
- development

pool:
  vmImage: 'macos-12'

variables:
  BUNDLER_PATH: vendor/bundle
  ARTIFACTS_DEFAULT_PATH: build
  TEST_REPORTS_DEFAULT_PATH: reports

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '2.7'
    addToPath: true
- script: rake setup
  displayName: 'Configure project'
- script: bundle exec rake xcode:tests[true]
  displayName: 'Run tests'
  env:
    DANGER_GITHUB_API_TOKEN: $(danger-github-api-token)
- task: PublishTestResults@2
  inputs:
    testRunner: JUnit
    testResultsFiles: $(TEST_REPORTS_DEFAULT_PATH)/*.xml
  condition: succeededOrFailed()
- task: PublishPipelineArtifact@0
  inputs:
    artifactName: 'logs'
    targetPath: $(ARTIFACTS_DEFAULT_PATH)
  condition: succeededOrFailed()
- task: PublishPipelineArtifact@0
  inputs:
    artifactName: 'testResults'
    targetPath: $(TEST_REPORTS_DEFAULT_PATH)
  condition: succeededOrFailed()
